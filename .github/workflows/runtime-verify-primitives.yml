name: Primitive Logic Verification

on:
    push:
        branches: [main]
        paths:
            - 'packages/runtime/src/**'
            - 'packages/runtime/config/**'
            - 'packages/runtime/package.json'
            - 'packages/runtime/tsconfig.json'
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    unit-tests:
        name: Run Logic Unit Tests (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: ['18', '20']
                exclude:
                    # Only test Node 20 on non-Linux platforms
                    - os: ubuntu-latest
                      node-version: '18'
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  cache-dependency-path: packages/runtime/package-lock.json

            - name: Install Salesforce CLI
              run: npm install --global @salesforce/cli

            - name: Install Dependencies
              working-directory: packages/runtime
              run: npm ci --ignore-scripts

            - name: Run Jest Suite
              working-directory: packages/runtime
              shell: bash
              run: |
                  npm test 2>&1 | tee test-output.log
                  exit_code=${PIPESTATUS[0]}
                  echo "## ðŸ§ª Logic Unit Tests (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
                  if [ $exit_code -eq 0 ]; then
                     echo "âœ… **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
                  else
                     echo "âŒ **Test Failures Detected**" >> $GITHUB_STEP_SUMMARY
                     echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                     tail -n 20 test-output.log >> $GITHUB_STEP_SUMMARY
                     echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                     exit 1
                  fi

            - name: Upload Coverage Reports
              uses: codecov/codecov-action@v5
              if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
              with:
                  file: ./packages/runtime/coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella

    code-hygiene:
        name: Verify Code Standards
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: packages/runtime/package-lock.json

            - name: Install Salesforce CLI
              run: npm install --global @salesforce/cli

            - name: Install Dependencies
              working-directory: packages/runtime
              run: npm ci --ignore-scripts

            - name: Run Code Hygiene Checks
              working-directory: packages/runtime
              run: |
                  echo "## ðŸ§¹ Code Hygiene Status" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

                  echo -n "| ESLint | " >> $GITHUB_STEP_SUMMARY
                  if npm run lint; then echo "âœ… Pass | " >> $GITHUB_STEP_SUMMARY; else echo "âŒ Fail | " >> $GITHUB_STEP_SUMMARY; fi

                  echo -n "| Prettier | " >> $GITHUB_STEP_SUMMARY
                  if npm run format:check; then echo "âœ… Pass | " >> $GITHUB_STEP_SUMMARY; else echo "âŒ Fail | " >> $GITHUB_STEP_SUMMARY; fi

            - name: Verify Build
              working-directory: packages/runtime
              run: npm run build

            - name: Check Dependencies
              working-directory: packages/runtime
              run: npm audit --audit-level high

    dependency-review:
        name: Dependency Review
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Dependency Review
              uses: actions/dependency-review-action@v4
