name: Knowledge Bot

on:
    issues:
        types: [opened, edited]
    issue_comment:
        types: [created]

permissions:
    contents: read
    issues: write

jobs:
    answer-question:
        if: |
            (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'question')) ||
            (github.event_name == 'issue_comment' && startswith(github.event.comment.body, '/ask'))
        runs-on: ubuntu-latest
        env:
            GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'

            - name: Install System Dependencies
              run: |
                  npm ci
                  pip install -r packages/knowledge/requirements.txt

            - name: Extract Question
              id: extract
              shell: bash
              run: |
                  if [[ "${{ github.event_name }}" == "issues" ]]; then
                    QUESTION="${{ github.event.issue.title }} ${{ github.event.issue.body }}"
                  else
                    # Remove '/ask' prefix
                    QUESTION=$(echo "${{ github.event.comment.body }}" | sed 's/^[/]ask //g')
                  fi

                  # Sanitize for bash variable but keep quotes for python arg
                  echo "QUESTION<<EOF" >> $GITHUB_ENV
                  echo "$QUESTION" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Run Knowledge Pipeline
              id: rag
              shell: bash
              run: |
                  # Use the CLI to get answer. Capture output.
                  # Note: We need to make sure main.py prints ONLY the answer or effectively finding the line.
                  # The current CLI prints a lot of logs.
                  # We might need to pipe to file and extract the last "RAG Response:" block?

                  # Let's try running it and capturing stdout
                  # Redirect stderr to devnull to avoid noise

                  OUTPUT=$(npm run knowledge:ask -- "$QUESTION")

                  # Extract the response part.
                  # Assuming the python script prints "RAG Response:" followed by the answer.
                  # We can use sed/awk to parse.
                  # Or simpler: Just post the whole log if it's clean enough?
                  # The logs contain 'glassops-agent: loading...', 'Starting...', 'Querying...'
                  # Let's try to extract everything after "RAG Response:"

                  ANSWER=$(echo "$OUTPUT" | sed -n '/RAG Response:/,$p')

                  if [ -z "$ANSWER" ]; then
                     ANSWER="I processed your question but couldn't generate a clear response. Check the logs."
                  fi

                  echo "ANSWER<<EOF" >> $GITHUB_ENV
                  echo "$ANSWER" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Post Comment
              uses: actions/github-script@v6
              with:
                  script: |
                      const answer = process.env.ANSWER;
                      const actor = context.actor;

                      const body = `Hello @${actor}! Here is what I found in the knowledge base:\n\n${answer}\n\n---\n*Generated by GlassOps Knowledge Bot*`;

                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        body: body
                      });
