name: Runtime Docker Build & Test

on:
    push:
        branches: [main, develop]
        paths:
            - 'packages/runtime/**'
            - '.github/workflows/runtime-*.yml'
    pull_request:
        branches: [main]
        paths:
            - 'packages/runtime/**'
    workflow_dispatch:

env:
    RUNTIME_DIR: packages/runtime

jobs:
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        outputs:
            image_tag: ${{ steps.meta.outputs.tags }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Docker Metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: glassops/runtime
                  tags: |
                      type=sha,prefix=
                      type=ref,event=branch
                      type=ref,event=pr

            - name: Build Docker Image
              uses: docker/build-push-action@v5
              with:
                  context: ${{ env.RUNTIME_DIR }}
                  push: false
                  load: true
                  tags: glassops/runtime:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Container Smoke Test
              run: |
                  docker run --rm \
                    -e GITHUB_WORKSPACE=/workspace \
                    -e GITHUB_ACTOR=test-user \
                    -e GITHUB_REPOSITORY=test-org/test-repo \
                    -e GLASSOPS_SKIP_AUTH=true \
                    -e GLASSOPS_ENFORCE_POLICY=false \
                    -v $(pwd):/workspace \
                    glassops/runtime:test || echo "Container exited (expected without full config)"

    test:
        name: Unit Tests & Linting
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: ${{ env.RUNTIME_DIR }}/package-lock.json

            - name: Install Dependencies
              working-directory: ${{ env.RUNTIME_DIR }}
              run: npm ci

            - name: Run ESLint
              working-directory: ${{ env.RUNTIME_DIR }}
              run: npm run lint

            - name: Run Prettier Check
              working-directory: ${{ env.RUNTIME_DIR }}
              run: npm run format:check

            - name: Run Unit Tests
              working-directory: ${{ env.RUNTIME_DIR }}
              run: npm test

            - name: Upload Coverage
              uses: codecov/codecov-action@v4
              with:
                  files: ./${{ env.RUNTIME_DIR }}/coverage/lcov.info
                  flags: runtime-unit

    security-scan:
        name: Security Scanning
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Run Trivy Vulnerability Scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: ${{ env.RUNTIME_DIR }}
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy Results
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: 'trivy-results.sarif'

            - name: npm Audit
              working-directory: ${{ env.RUNTIME_DIR }}
              run: npm audit --audit-level=high

    integration-test:
        name: Integration Test
        runs-on: ubuntu-latest
        needs: [build, test]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Test Config
              run: |
                  mkdir -p ${{ env.RUNTIME_DIR }}/config
                  cat > ${{ env.RUNTIME_DIR }}/config/devops-config.json << 'EOF'
                  {
                    "governance": {
                      "enabled": true,
                      "freeze_windows": []
                    },
                    "runtime": {
                      "cli_version": "latest",
                      "node_version": "20"
                    }
                  }
                  EOF

            - name: Test Action (Skip Auth)
              id: glassops
              uses: ./packages/runtime
              with:
                  jwt_key: 'dummy-key-for-test'
                  client_id: 'dummy-client'
                  username: 'test@example.com'
                  skip_auth: 'true'
                  enforce_policy: 'false'

            - name: Verify Outputs
              run: |
                  echo "## üß™ Integration Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| runtime_id | ${{ steps.glassops.outputs.runtime_id }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| glassops_ready | ${{ steps.glassops.outputs.glassops_ready }} |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.glassops.outputs.glassops_ready }}" != "true" ]; then
                    echo "‚ùå GlassOps did not report ready state"
                    exit 1
                  fi
                  echo "‚úÖ Integration test passed"

    publish:
        name: Publish Docker Image
        runs-on: ubuntu-latest
        needs: [build, test, security-scan, integration-test]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Docker Login
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Extract Metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: glassops/runtime
                  tags: |
                      type=ref,event=branch
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha

            - name: Build and Push
              uses: docker/build-push-action@v5
              with:
                  context: ${{ env.RUNTIME_DIR }}
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
