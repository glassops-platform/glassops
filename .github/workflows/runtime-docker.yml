name: Runtime Docker Build & Test

on:
    push:
        branches: [main, develop]
        paths:
            - 'packages/runtime/**'
            - '.github/workflows/runtime-*.yml'
    pull_request:
        branches: [main]
        paths:
            - 'packages/runtime/**'
    workflow_dispatch:

permissions:
    contents: read
    security-events: write
    packages: write

env:
    RUNTIME_DIR: packages/runtime

jobs:
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        outputs:
            image_tag: ${{ steps.meta.outputs.tags }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Docker Metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: glassops/runtime
                  tags: |
                      type=sha,prefix=
                      type=ref,event=branch
                      type=ref,event=pr

            - name: Build Docker Image
              uses: docker/build-push-action@v5
              with:
                  context: ${{ env.RUNTIME_DIR }}
                  push: false
                  load: true
                  tags: glassops/runtime:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Container Smoke Test
              run: |
                  docker run --rm \
                    -e GITHUB_WORKSPACE=/workspace \
                    -e GITHUB_ACTOR=${{ github.actor }} \
                    -e GITHUB_REPOSITORY=${{ github.repository }} \
                    -e INPUT_JWT_KEY="${{ secrets.SF_JWT_KEY }}" \
                    -e INPUT_CLIENT_ID="${{ secrets.SF_CLIENT_ID }}" \
                    -e INPUT_USERNAME="${{ vars.SF_USERNAME }}" \
                    -e GLASSOPS_SKIP_AUTH=false \
                    -e GLASSOPS_ENFORCE_POLICY=true \
                    -v $(pwd):/workspace \
                    glassops/runtime:test

    test:
        name: Go Unit Tests & Linting
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.25'
                  cache-dependency-path: packages/runtime/go.sum

            - name: Run Go Vet
              working-directory: ${{ env.RUNTIME_DIR }}
              run: go vet ./...

            - name: Create Test Config (Suppress Warnings)
              run: |
                  mkdir -p ${{ env.RUNTIME_DIR }}/config
                  echo '{"governance":{"enabled":false}}' > ${{ env.RUNTIME_DIR }}/config/devops-config.json

            - name: Run Go Tests
              working-directory: ${{ env.RUNTIME_DIR }}
              run: go test ./... -v -coverprofile=coverage.out

            - name: Upload Coverage
              uses: codecov/codecov-action@v4
              with:
                  files: ./${{ env.RUNTIME_DIR }}/coverage.out
                  flags: runtime-unit

    security-scan:
        name: Security Scanning
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Run Trivy Vulnerability Scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: ${{ env.RUNTIME_DIR }}
                  format: 'sarif'
                  output: 'trivy-results.sarif'

            - name: Upload Trivy Results
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: 'trivy-results.sarif'

            - name: Setup Go for Security Scan
              uses: actions/setup-go@v5
              with:
                  go-version: '1.25'

            - name: Run Go Vulnerability Check
              working-directory: ${{ env.RUNTIME_DIR }}
              run: |
                  go install golang.org/x/vuln/cmd/govulncheck@latest
                  govulncheck ./...

    integration-test:
        name: Integration Test
        runs-on: ubuntu-latest
        needs: [build, test]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Test Config
              run: |
                  mkdir -p ${{ env.RUNTIME_DIR }}/config
                  cat > ${{ env.RUNTIME_DIR }}/config/devops-config.json << 'EOF'
                  {
                    "governance": {
                      "enabled": true,
                      "freeze_windows": []
                    },
                    "runtime": {
                      "cli_version": "latest",
                      "node_version": "20"
                    }
                  }
                  EOF

            - name: Run Runtime Action (Authenticated)
              id: glassops
              uses: ./packages/runtime
              with:
                  jwt_key: ${{ secrets.SF_JWT_KEY }}
                  client_id: ${{ secrets.SF_CLIENT_ID }}
                  username: ${{ vars.SF_USERNAME }}
                  skip_auth: 'false'
                  enforce_policy: 'true'

            - name: Verify Outputs
              run: |
                  echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| runtime_id | ${{ steps.glassops.outputs.runtime_id }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| glassops_ready | ${{ steps.glassops.outputs.glassops_ready }} |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.glassops.outputs.glassops_ready }}" != "true" ]; then
                    echo "GlassOps did not report ready state"
                    exit 1
                  fi

                  # New: Verify V1 Artifact Generation
                  if [ ! -f ".glassops/glassops-permit.json" ]; then
                    echo "Missing Permit Artifact"
                    exit 1
                  fi
                  if [ ! -f ".glassops/glassops-contract.json" ]; then
                    echo "Missing Contract Artifact"
                    exit 1
                  fi

                  echo "Integration test passed (Artifacts Verified)"

            - name: Upload Runtime Artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: runtime-artifacts
                  path: .glassops/**
                  if-no-files-found: warn

    # publish:
    #     name: Publish Docker Image
    #     runs-on: ubuntu-latest
    #     needs: [build, test, security-scan, integration-test]
    #     if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    #     steps:
    #         - name: Checkout
    #           uses: actions/checkout@v4

    #         - name: Set up Docker Buildx
    #           uses: docker/setup-buildx-action@v3

    #         - name: Docker Login
    #           uses: docker/login-action@v3
    #           with:
    #               username: ${{ secrets.DOCKER_USERNAME }}
    #               password: ${{ secrets.DOCKER_PASSWORD }}

    #         - name: Extract Metadata
    #           id: meta
    #           uses: docker/metadata-action@v5
    #           with:
    #               images: glassops/runtime
    #               tags: |
    #                   type=ref,event=branch
    #                   type=semver,pattern={{version}}
    #                   type=semver,pattern={{major}}.{{minor}}
    #                   type=sha

    #         - name: Build and Push
    #           uses: docker/build-push-action@v5
    #           with:
    #               context: ${{ env.RUNTIME_DIR }}
    #               push: true
    #               tags: ${{ steps.meta.outputs.tags }}
    #               labels: ${{ steps.meta.outputs.labels }}
    #               cache-from: type=gha
    #               cache-to: type=gha,mode=max
