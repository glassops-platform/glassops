name: Documentation

on:
    pull_request:
        paths:
            - 'glassspec/**'
            - 'packages/*/src/**'
            - 'utils/**'
            - 'docs/generated/**'

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    validate:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - uses: actions/setup-python@v4
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install Python dependencies
              run: pip install -r packages/knowledge/requirements.txt

            - name: Install dependencies
              run: npm ci

            - name: Build Agent
              run: npm run build -w @glassops/agent

            - name: Get changed files
              id: changed-files
              uses: tj-actions/changed-files@v44
              with:
                  files: |
                      packages/**/*.{ts,js,mjs,tsx,jsx,go,py,yml,yaml,json,tf,cls,trigger}
                      utils/**/*.{ts,js}
                  files_ignore: |
                      packages/**/dist/**
                      packages/**/build/**
                      packages/**/node_modules/**
                      packages/**/.github/**
                      packages/**/package-lock.json

            - name: Regenerate Docs
              id: docs
              shell: bash
              if: steps.changed-files.outputs.any_changed == 'true'
              run: |
                  # Capture output of buffer to env vars for comment
                  # Construct args for changed files
                  FILES="${{ steps.changed-files.outputs.all_changed_files }}"
                  ARGS=""
                  for file in $FILES; do
                      ARGS="$ARGS -p $file"
                  done

                  echo "Processing changed files: $FILES"

                  OUTPUT=$(npm run docs:ai -- $ARGS 2>&1)
                  echo "$OUTPUT"

                  # Save to ENV for next step
                  echo "DOCS_SUMMARY<<EOF" >> $GITHUB_ENV
                  echo "$OUTPUT" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV
              env:
                  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

            - name: Post Generation Summary
              uses: actions/github-script@v6
              if: github.event_name == 'pull_request'
              continue-on-error: true
              with:
                  script: |
                      const anyChanged = '${{ steps.changed-files.outputs.any_changed }}';

                      let body = '';
                      if (anyChanged !== 'true') {
                          body = `### ðŸ“š Documentation Generation Summary\n\nâœ… No relevant code changes detected. Documentation generation skipped.`;
                      } else {
                          const summary = process.env.DOCS_SUMMARY || 'No output captured.';
                          // Truncate logs if needed
                          const logSection = summary.length > 60000 ? summary.substring(summary.length - 60000) : summary;

                          body = `### ðŸ“š Documentation Generation Summary
                          
                          <details>
                          <summary>Click to view incremental generation logs</summary>
                          
                          \`\`\`text
                          ${logSection}
                          \`\`\`
                          </details>
                          `.replace(/^ +/gm, '');
                      }

                      await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: body
                      });

            - name: Check for Drift
              run: |
                  # Check for any changes in the repo after generation
                  if ! git diff --quiet; then
                    echo "Generated docs are out of sync with code/schemas."
                    echo "Run 'npm run docs:ai' locally and commit the changes."
                    git diff --name-only
                    exit 1
                  fi
                  echo "Documentation is up to date."
